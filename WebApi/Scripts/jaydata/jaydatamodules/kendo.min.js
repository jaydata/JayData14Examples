// JayData 1.4.0
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
(function(d){var l=d.Entity.inheritedTypeProcessor;d.kendo={};d.kendo.BaseModelType=kendo.data.Model.define({init:function(a){kendo.data.Model.fn.init.call(this,a)}});d.kendo.attachMode=!0;d.EntityAttachMode&&(d.kendo.attachMode=d.EntityAttachMode.KeepChanges);var q={"$data.Blob":"string","$data.String":"string","$data.Boolean":"boolean","$data.Integer":"number","$data.Number":"number","$data.Date":"date","$data.DateTimeOffset":"date","$data.Time":"string","$data.Byte":"number","$data.SByte":"number",
"$data.Int16":"number","$data.Int32":"number","$data.Int64":"number","$data.Decimal":"string","$data.Float":"number"};d.Entity.inheritedTypeProcessor=function(a){function f(b){var e=a.memberDefinitions,g={};e.getPublicMappedProperties().forEach(function(a){var c=d.Container.resolveName(a.type);g[a.name]={type:q[c]||"object",nullable:c==="$data.Boolean"?true:a.required!==true,defaultValue:a.defaultValue,editable:!a.computed,validation:{required:"$data.Boolean"===c?false:a.required||"nullable"in a?
!a.nullable:false}}});var c={fields:g,init:function(c){var e=[];b&&b.owningContextType&&(e=b.owningContextType.memberDefinitions.getPublicMappedProperties().filter(function(a){return d.Container.resolveType(a.type)===d.EntitySet}).map(function(a){return d.Container.resolveType(a.elementType)}));var g={entityBuilder:function(a,h){h.forEach(function(h){if(h.key!==true&&(h.required===true||h.nullable===false)){var b=d.Container.resolveType(h.type);if(b.isAssignableTo&&b.isAssignableTo(d.Entity)&&e.indexOf(b)===
-1){var f;c&&(f=c[h.name]);a[h.name]=new b(f,g)}}})}},h=c instanceof a?c:new a(c,g),f=h.initData,j={},k;for(k in f){var m=a.getMemberDefinition(k),i=f[k];if(i instanceof d.Entity){i=i.asKendoObservable();j[k]=i}else if(m&&d.Container.resolveType(m.type)===Array){var l=i=d.Container.resolveType(m.elementType);i.asKendoModel&&(l=i.asKendoModel());i=new kendo.data.ObservableArray(f[k],l);j[k]=i;j[k].bind("change",function(){h.changeFromKendo=true;this.parent().dirty=true;h[m.name]=this.toJSON();delete h.changeFromKendo})}else j[k]=
m&&d.Container.resolveType(m.type)===d.Blob?d.Blob.toBase64(i):i}i=a.memberDefinitions.getPublicMappedProperties().filter(function(a){return d.Container.resolveType(a.dataType)===Array&&!d.Container.resolveType(a.elementType).asKendoModel});for(k=0;k<i.length;k++){var n=i[k];if(f[n.name]===null||f[n.name]===void 0){j[n.name]=new kendo.data.ObservableArray([],d.Container.resolveType(n.elementType));j[n.name].bind("change",function(){h.changeFromKendo=true;this.parent().dirty=true;h[n.name]=this.toJSON();
delete h.changeFromKendo})}}var p=this;this.innerInstance=function(){return h};d.kendo.BaseModelType.fn.init.call(this,j);h.propertyChanged.attach(function(a,c){var b=c.newValue,e=h.getType().getMemberDefinition(c.propertyName);if(this.changeFromKendo){if(d.Container.resolveType(e.type)===d.Blob){b=d.Blob.toString(b);b=d.Container.convertTo(atob(b),d.Blob);h.changeFromJay=true;h.initData[e.name]=b;delete h.changeFromJay}}else{b=b?b.asKendoObservable?b.asKendoObservable():b:b;h.changeFromJay=true;
d.Container.resolveType(e.type)===d.Blob&&b&&(b=d.Blob.toBase64(b));p.set(c.propertyName,b);e.computed&&p[c.propertyName]!==b&&(p[c.propertyName]=b);delete h.changeFromJay}});this.bind("set",function(a){var c=a.field,e=c.split(".");h.changeFromKendo=true;if(e.length==1){e=a.value;if(!h.changeFromJay){e=e.innerInstance?e.innerInstance():e;h[c]=e;b&&b.autoSave&&h.save()}}else{c=h[e[0]];c instanceof d.Entity&&(h[e[0]]=c)}delete h.changeFromKendo});b&&b.newInstanceCallback&&b.newInstanceCallback(h)},
save:function(){return this.innerInstance().save()},remove:function(){return this.innerInstance().remove()}},e=e.getKeyProperties();switch(e.length){case 0:break;case 1:c.id=e[0].name;break;default:console.warn("entity with multiple keys not supported")}d.Trace.log("md",c);return kendo.data.Model.define(d.kendo.BaseModelType,c)}function g(a,e){if(e.provider){var d=(e.databaseName||"")+(e.tableName||"")+(e.url||"")+(e.apiUrl||"")+(e.oDataServiceHost||""),c={provider:e.provider,databaseName:e.databaseName,
tableName:e.tableName,dataSource:e.url,apiUrl:e.apiUrl,oDataServiceHost:e.oDataServiceHost};Object.keys(c).forEach(function(a){delete e[a]});a.setStore(d,c);return d}}a.asKendoModel=function(b){var e=b||a;return e.kendoModelType||(e.kendoModelType=f(b))};a.prototype.asKendoObservable=function(b){return new (a.asKendoModel(b))(this)};a.asKendoDataSource=function(b,e,f){b=b||{};e=e||{};f=g(a,b)||f;f=d.ItemStore._getStoreAlias(a,f);return d.ItemStore._getContextPromise(f,a).getEntitySetFromElementType(a).asKendoDataSource(b,
e)};l&&l(a)};d.Queryable.addMember("asKendoColumns",function(a){function f(a){a=Array.isArray(a)?a:[a];a=this.concat(a);return e(a)}function g(a){a=Array.isArray(a)?a:[a];a=a.concat(this);return e(a)}function b(a,c){var b=this.filter(function(c){return c.field==a})[0];$.extend(b,c);return this}function e(a){a.prepend=g;a.append=f;a.setColumn=b;return a}var j=[],a=a||{},c=a.$showComplexFields===true;delete a.$showComplexFields;this.defaultType.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(c||
q[d.Container.resolveName(b.type)]){var e={field:b.name};$.extend(e,a[b.name]||{});j.push(e)}});return e(j)});d.EntityContext.addProperty("EntitySetNames",function(){var a=this;return Object.keys(a._entitySetReferences).map(function(d){return a._entitySetReferences[d].tableName})});d.Queryable.addMember("asKendoModel",function(a){a.owningContextType=a.owningContextType||this.entityContext.getType();return this.defaultType.asKendoModel(a)});d.Queryable.addMember("asKendoRemoteTransportClass",function(){var a=
this,f=a.entityContext;return kendo.data.RemoteTransport.extend({init:function(){this.items=[]},read:function(g){a.entityContext.onReady().then(function(){var b=a,e=a.entityContext.storageProvider.supportedSetOperations.withInlineCount,f=!e&&a.entityContext.storageProvider.supportedSetOperations.length;e&&(b=b.withInlineCount());if(g.data.filter){var c="",r={};g.data.filter.filters.forEach(function(a,b){b>0&&(c=c+(g.data.filter.logic=="or"?" || ":" && "));switch(a.operator){case "eq":c=c+("it."+a.field);
c=c+(" == this."+a.field);break;case "neq":c=c+("it."+a.field);c=c+(" != this."+a.field);break;case "startswith":c=c+("it."+a.field);c=c+(".startsWith(this."+a.field+")");break;case "contains":c=c+("it."+a.field);c=c+(".contains(this."+a.field+")");break;case "doesnotcontain":c=c+"!";c=c+("it."+a.field);c=c+(".contains(this."+a.field+")");break;case "endswith":c=c+("it."+a.field);c=c+(".endsWith(this."+a.field+")");break;case "gte":c=c+("it."+a.field);c=c+(" >= this."+a.field);break;case "gt":c=c+
("it."+a.field);c=c+(" > this."+a.field);break;case "lte":c=c+("it."+a.field);c=c+(" <= this."+a.field);break;case "lt":c=c+("it."+a.field);c=c+(" < this."+a.field);break;default:d.Trace.log("unknown operator",a.operator)}r[a.field]=a.value});b=b.filter(c,r)}var l=b;g.data.sort&&g.data.sort.forEach(function(a){b=b.order((a.dir=="desc"?"-":"")+a.field)});g.data.skip&&(b=b.skip(g.data.skip));g.data.take&&(b=b.take(g.data.take));var o=[];o.push(b.toArray());f?o.push(l.length()):e||o.push(l.toArray());
d.Trace.log(o);jQuery.when.apply(this,o).then(function(a,c){var b={data:a.map(function(a){return a.asKendoObservable()}),total:e?a.totalCount:f?c:c.length};d.Trace.log(b);g.success(b)}).fail(function(){console.log("error in create");g.error({},arguments)})})},create:function(d,b){a.entityContext.onReady().then(function(){if(b.length>1){var a=[];b.forEach(function(b){a.push(b.innerInstance())});f.addMany(a);f.saveChanges().then(function(){var b=[];a.forEach(function(a){b.push(a.initData)});d.success()}).fail(function(){console.log("error in create");
d.error({},arguments);f.stateManager.reset()})}else b[0].innerInstance().save(f.storeToken).then(function(){d.success()}).fail(function(){console.log("error in create");d.error({},arguments)})})},update:function(g,b){a.entityContext.onReady().then(function(){if(b.length>1){b.map(function(a){return a.innerInstance()}).forEach(function(a){f.attach(a,d.kendo.attachMode)});f.saveChanges().then(function(){g.success()}).fail(function(){f.stateManager.reset();g.error({},arguments)})}else b[0].innerInstance().save(void 0,
void 0,d.kendo.attachMode).then(function(){g.success()}).fail(function(){g.error({},arguments)})})},destroy:function(d,b){a.entityContext.onReady().then(function(){if(b.length>1){b.forEach(function(a){f.remove(a.innerInstance())});f.saveChanges().then(function(){d.success({data:d.data})}).fail(function(){f.stateManager.reset();d.error({},"error",d.data)})}else b[0].innerInstance().remove().then(function(){d.success({data:d.data})}).fail(function(){f.stateManager.reset();d.error({},"error",d.data)})})},
setup:function(){d.Trace.log("setup");d.Trace.log(arguments)}})});var s=kendo.data.DataSource.extend({init:function(){kendo.data.DataSource.fn.init.apply(this,arguments)},createItem:function(a){return new this.options.schema.model(a)},_promise:function(a,d,g){var b=this,e=$.extend,j=b.transport;return $.Deferred(function(c){j[g].call(j,e({success:function(a){c.resolve({response:a,models:d,type:g})},error:function(a,d,e){c.reject(a);b.error(a,d,e)}},a),d)}).promise()}});d.kendo=d.kendo||{};d.kendo.defaultPageSize=
25;d.Queryable.addMember("asKendoDataSource",function(a,f){var f=f||{},g=this.asKendoModel(f),a=a||{};a.serverPaging=a.serverPaging===void 0?true:a.serverPaging;a.serverFiltering=a.serverFiltering===void 0?true:a.serverFiltering;a.serverSorting=a.serverSorting===void 0?true:a.serverSorting;a.pageSize=a.pageSize===void 0?d.kendo.defaultPageSize:a.pageSize;var b=this.asKendoRemoteTransportClass(g);a.transport=new b;a.schema={model:g,data:"data",total:"total"};return new s(a)});kendo.data.binders.submit=
kendo.data.Binder.extend({init:function(a,d,g){kendo.data.Binder.fn.init.call(this,a,d,g);$(a).bind("submit",function(){var a=d.submit.source,e=a[d.submit.path];if(typeof e==="function"){e.apply(a,arguments);return false}})},refresh:function(){}})})($data);
